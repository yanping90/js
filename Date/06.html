<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <script src="../G.js"></script>
  <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="../template.js"></script>
  <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
</head>
<body>
<div class="date container">
  <div class="rili6">
    <div class="title clearfix">
      <div class="titleL"><a></a></div>
      <div class="titleM"></div>
      <div class="titleR"><a></a></div>
    </div>
    <ul class="weekday list-inline"></ul>
    <ul class="date-days list-inline" style=""></ul>
  </div>
</div>
<script type="text/html" id="list">
  {{each list as value}}
  <li>{{value}}</li>
  {{/each}}
</script>
<script>
  function Calendar(opt) {
    if (typeof opt == "object") {
      this.config(opt);
    }
  }
  Calendar.prototype.config = function (opt) {
    this.settings = $.extend({
      onLast: true
      , onNext: true
      , selectLast: $(".titleL")
      , selectNext: $(".titleR")
      ,lastContent:"上一月"
      ,nextContent:"下一月"
      , selectWeekTitle: $(".titleM")
      , selectWeek: $(".weekday")
      , selectDay: $(".date-days")
      , displayDate: new Date
    }, opt);
    this.display(this.settings.displayDate);
    if (this.settings.onLast) {
      var _self = this;
      var arrTitle;
      _self.settings.selectLast.on("click", function () {
        arrTitle = (_self.settings.selectWeekTitle.html()).match(/^(\d{4})\D(\d{2})\D$/);
        _self.display(_self.getLastMonth(arrTitle[1] + "-" + arrTitle[2] + "-01"));
      });
    }

    if (this.settings.onNext) {
      var _self = this;
      var arrTitle;
      _self.settings.selectNext.on("click", function () {
        arrTitle = (_self.settings.selectWeekTitle.html()).match(/^(\d{4})\D(\d{2})\D$/);
        _self.display(_self.getNextMonth(arrTitle[1] + "-" + arrTitle[2] + "-01"));
      });
    }

  }
  Calendar.prototype.isValidDate = function (timeString) {
    return !isNaN(new Date(timeString).getTime());
  }
  Calendar.prototype.formatDate = function (timeString) {
    var d;
    if (Object.prototype.toString.call(timeString) == "[object Date]") {
      d = timeString;
    }
    else if (this.isValidDate(timeString)) {
      d = new Date(timeString);
    }
    else {
      return timeString;
    }
    return d.getFullYear() + "-" + Math.abs(d.getMonth() + 1) + "-01";
  }
  Calendar.prototype.getNextMonth = function (timeString) {
    var d, month, nextMonth, year;
    if (this.isValidDate(timeString)) {
      d = new Date(timeString);
      month = d.getMonth() + 1;
      nextMonth = "0" + (month % 12 + 1);
      year = d.getFullYear();
      if (month == 12) {
        year++;
      }
      return year + "-" + nextMonth.substr(-2) + "-01";
    } else {
      return "";
    }
  }
  Calendar.prototype.getLastMonth = function (timeString) {
    var d, lastMonth, year;
    if (this.isValidDate(timeString)) {
      d = new Date(timeString);
      year = d.getFullYear();
      lastMonth = d.getMonth();
      if (lastMonth == 0) {
        lastMonth = 12;
        year--;
      }
      return year + "-" + ("0" + lastMonth).substr(-2) + "-01";
    } else {
      return "";
    }
  }
  Calendar.prototype.getMonthDays = function (timeString) {
    return new Date(new Date(this.getNextMonth(timeString)).getTime() - 86400000).getDate();
  }
  Calendar.prototype.fillFrontDays = function (timeString) {
    var arrDays = [];
    var d, idx, i, days;
    var _self = this;
    if (_self.isValidDate(timeString)) {
      d = new Date(timeString);
      idx = new Date(d.getFullYear() + "-" + ("0" + (d.getMonth() + 1).toString()).substr(-2) + "-01").getDay();
      days = _self.getMonthDays(_self.getLastMonth(timeString));
      for (var i = days - idx + 1; i <= days; i++) {
        arrDays.push(i);
      }
      return arrDays;
    } else {
      return "空数组";
    }
  }
  Calendar.prototype.fillBackDays = function (timeString) {
    var arrDays = [];
    var idx, d, i;
    var _self = this;
    if (_self.isValidDate(timeString)) {
      d = new Date(timeString);
      idx = new Date(d.getFullYear() + "-" + ("0" + (d.getMonth() + 1).toString()).substr(-2) + "-" + _self.getMonthDays(timeString)).getDay();
      for (i = 1; i < 7 - idx; i++) {
        arrDays.push(i);
      }
      return arrDays;
    } else {
      return "空数组";
    }
  }
  Calendar.prototype.fillDays = function (timeString) {
    var _self = this;
    var i, j, arrFront, arrBack, days;
    if (_self.isValidDate(timeString)) {
      arrFront = _self.fillFrontDays(timeString);
      arrBack = _self.fillBackDays(timeString);
      days = _self.getMonthDays(timeString);
      for (i = 1; i <= days; i++) {
        arrFront.push(i);
      }
      for (j = 1; j <= arrBack.length; j++) {
        arrFront.push(j);
      }
      return arrFront;
    } else {
      return "空数组";
    }
  }

  Calendar.prototype.addDateClass = function(timeString){
    var _self = this;
    var idxFront,idxCurrentBack,arrDay, i,j;
    arrDay =_self.settings.selectDay.children();
    if(this.isValidDate(timeString)){
      idxFront=_self.fillFrontDays(timeString).length;
      idxFrontCurrent = idxFront + _self.getMonthDays(timeString);
      for(i=0;i<idxFront;i++){
        arrDay.eq(i).attr("class","disabled");
      }
      for(j = idxFrontCurrent; j<=arrDay.length; j++){
        arrDay.eq(j).attr("class","disabled");
      }
      return arrDay;
    }else{
      return [];
    }
  }

  Calendar.prototype.showDays = function (timeString) {
    var _self = this;
    if (_self.isValidDate(timeString)) {
      _self.settings.selectWeek.html(
        template(
          "list", {
            list: ["日", "一", "二", "三", "四", "五", "六"]
          })
      );
      _self.settings.selectDay.html(
        template("list", {
          list: _self.fillDays(timeString)
        })
      );
      _self.addDateClass(timeString);
    }

  }

  Calendar.prototype.getYearMonth = function (timeString) {
    var _self = this;
    var d;
    if (_self.isValidDate(timeString)) {
      d = new Date(timeString);
      return d.getFullYear() + "年" + ("0" + (d.getMonth() + 1).toString()).substr(-2) + "月";
    }
  }

  Calendar.prototype.display = function (timeString) {
    var _self = this;
    _self.settings.selectLast.children().html(_self.settings.lastContent);
    _self.settings.selectNext.children().html(_self.settings.nextContent);
    _self.settings.selectWeekTitle.html(_self.getYearMonth(timeString));
    _self.showDays(timeString);
  }
</script>
</body>
</html>